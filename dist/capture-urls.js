'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

exports.default = function (data) {
  var i, len, pattern, ref, replacement, text, urlsFound;
  if (process.env.npm_lifecycle_event !== 'generate') {

    // Don't act unless generating
    return data;
  }

  // Stringify the data for easy replacing
  urlsFound = _store.foundAssets.length;
  text = (0, _stringify2.default)(data);
  ref = _store.options.assetRegex;

  // Loop through each pattern and replace asset URLs
  for (i = 0, len = ref.length; i < len; i++) {
    var _ref$i = ref[i];
    pattern = _ref$i.pattern;
    replacement = _ref$i.replacement;

    text = text.replace(pattern, function (oldUrl, filename) {
      var newPath, newUrl;

      // Auto lower case the filename
      if (replacement.autoLowercase) {
        filename = filename.toLowerCase();
        _logger2.default.info('auto case', filename);
      }

      // Make the new URL using the replacement
      newPath = replacement.storagePath.replace('$1', filename);
      newUrl = replacement.publicUrl.replace('$1', filename);

      // If this URL hasn't been found yet, add it to the list to be downloaded
      if (!_store.foundAssets.find(function (asset) {
        return asset.oldUrl === oldUrl;
      })) {
        _store.foundAssets.push({ oldUrl: oldUrl, newPath: newPath });
      }

      // Replace the old URL with the new one
      return newUrl;
    });
  }

  // Update the log
  _logger2.default.info('Found ' + (_store.foundAssets.length - urlsFound) + ' asset(s)');
  // Return updated object
  return JSON.parse(text);
};

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _store = require('./store');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

;

// Capture all the remote asset URLs and update them to a local path from an
// object of data
// Generated by CoffeeScript 2.4.1
// Deps (needed to be CJS style...)